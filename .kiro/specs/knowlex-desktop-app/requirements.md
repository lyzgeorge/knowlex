# Knowlex 桌面智能助理 - 需求文档

## 项目简介

Knowlex 是一款基于 Electron 构建的跨平台桌面应用，为研究人员、开发者、技术写作者、分析师等专业用户提供一站式桌面智能助理。应用集成了对话式 AI、项目管理、文件处理和个性化知识记忆功能。

## 功能需求

### 需求 1：基础聊天功能

**用户故事：** 作为用户，我希望能够创建新的聊天会话并与 AI 进行对话，同时能够上传相关文件作为上下文，以便获得基于我的文档的智能助理服务。

#### 验收标准

#### 1.1 聊天界面初始状态
1. WHEN 用户点击"New Chat"按钮或使用快捷键 ⌘/Ctrl+N THEN 系统 SHALL 在右侧主界面创建一个新的空白会话
2. WHEN 显示空白会话界面 THEN 系统 SHALL 在底部显示文本输入框，左下角显示"+"按钮（用于文件导入），右下角显示发送按钮
3. WHEN 输入框为空且无文件上传时 THEN 系统 SHALL 显示占位符文本"您在忙什么？"

#### 1.2 文件上传与管理
4. WHEN 用户点击"+"按钮 THEN 系统 SHALL 打开文件选择器，仅允许选择 .txt 和 .md 文件
5. WHEN 用户选择文件上传 THEN 系统 SHALL 支持最多同时上传10个文件，单文件最大1MB
6. WHEN 文件上传成功 THEN 系统 SHALL 在输入区域上方显示文件列表，每个文件显示为带文件名的图标卡片
7. WHEN 用户上传超过1MB的文件 THEN 系统 SHALL 弹出 toast 提示"文件大小超出1MB，未上传"
8. WHEN 用户上传超过10个文件 THEN 系统 SHALL 弹出 toast 提示"最多只能上传10个文件"
9. WHEN 用户悬浮在文件卡片上 THEN 系统 SHALL 显示删除按钮，允许移除该文件
10. WHEN 系统加载文件内容 THEN 系统 SHALL 将文件内容直接加载到消息上下文中，显示格式为"文件名：文件内容"

#### 1.3 消息发送与显示
11. WHEN 用户在输入框中输入消息并点击发送按钮 THEN 系统 SHALL 在聊天区域右侧显示用户消息
12. WHEN 显示用户消息 THEN 系统 SHALL 在消息上方显示上传的文件图标（如果有），消息下方显示用户输入的文本内容
13. WHEN 用户消息发送后 THEN 系统 SHALL 调用 OpenAI Compatible API 获取流式 AI 回复并在聊天区域左侧实时渲染
14. WHEN AI 回复中包含 Markdown 格式 THEN 系统 SHALL 正确渲染 Markdown 内容（包括标题、列表、代码块、粗体、斜体等）
15. WHEN 用户发送第一条消息成功 THEN 系统 SHALL 自动生成"Untitled Chat"会话并请求生成标题（最多重试3次，超时时间10秒）

#### 1.4 消息编辑与重发
16. WHEN 用户悬浮在自己的消息上 THEN 系统 SHALL 显示"编辑"按钮
17. WHEN 用户点击"编辑"按钮 THEN 系统 SHALL 将消息内容和文件列表重新加载到输入区域，允许用户修改文本和添加/删除文件
18. WHEN 用户编辑消息后重新发送 THEN 系统 SHALL 替换原消息和后续的 AI 回复，不保留历史版本
19. WHEN 用户重发消息 THEN 系统 SHALL 使用新的输入内容和文件列表作为上下文，之前的请求不会被记录或记忆

#### 1.5 AI 回复交互功能
20. WHEN AI 回复生成完成 THEN 系统 SHALL 在回复末尾显示"复制"和"重新生成"按钮
21. WHEN 用户点击"复制"按钮 THEN 系统 SHALL 将 AI 回复内容复制到剪贴板
22. WHEN 用户点击"重新生成"按钮 THEN 系统 SHALL 使用相同的用户输入重新请求 AI 回复并替换当前回复
23. WHEN AI 回复中包含文件引用代码（如 `[filename.md]` 格式） THEN 系统 SHALL 支持悬浮显示文件名提示
24. WHEN 用户点击文件引用 THEN 系统 SHALL 预留文件管理器弹窗功能接口（后续实现）
25. WHEN AI 回复中包含文件引用 THEN 系统 SHALL 在回复底部显示引用文件的图标列表

#### 1.6 连续对话功能
26. WHEN AI 回复生成完成 THEN 系统 SHALL 支持用户继续在同一会话中发送后续消息
27. WHEN 用户发送后续消息 THEN 系统 SHALL 保持完整的对话历史作为上下文
28. WHEN 用户在后续消息中上传新文件 THEN 系统 SHALL 将新文件内容添加到当前消息的上下文中
29. WHEN 聊天界面显示对话历史 THEN 系统 SHALL 保持用户消息在右侧、AI 回复在左侧的布局

#### 1.7 错误处理与超时
30. WHEN AI 响应超过60秒无首字节回复 THEN 系统 SHALL 弹出 toast 提示"网络/模型超时"并将用户输入内容放回输入框
31. WHEN API 调用失败 THEN 系统 SHALL 显示友好的错误提示并保留用户输入内容
32. WHEN 长会话超过 token 限制 THEN 系统 SHALL 对早期对话生成摘要（≤1000 tokens）并按"最近5轮对话+历史摘要"策略裁剪上下文

### 需求 2：项目管理功能

**用户故事：** 作为用户，我希望能够创建和管理项目，将相关的聊天会话和文件组织在一起，以便更好地管理我的工作内容。

#### 验收标准

1. WHEN 用户点击项目管理区域的"+"按钮 THEN 系统 SHALL 弹出新建项目对话框
2. WHEN 用户输入项目名称和描述（≤200字符，禁止换行）并确认 THEN 系统 SHALL 创建新项目并将描述保存为项目记忆
3. WHEN 用户点击项目名称 THEN 系统 SHALL 在右侧显示项目概览页面
4. WHEN 用户在项目概览页面发送消息 THEN 系统 SHALL 自动将会话归入该项目
5. WHEN 用户点击项目下的会话 THEN 系统 SHALL 在右侧显示完整的会话历史
6. WHEN 用户创建同名项目 THEN 系统 SHALL 提示"名称已存在"并要求重新输入
7. WHEN 用户删除项目 THEN 系统 SHALL 二次确认并同时删除项目中的所有会话、文件、记忆与知识
8. WHEN 用户重命名项目 THEN 系统 SHALL 实时反映到左侧项目树

### 需求 3：文件管理与 RAG 功能

**用户故事：** 作为用户，我希望能够上传和管理项目文件，并在聊天时自动检索相关内容，以便获得基于我的文档的智能回答。

#### 验收标准

1. WHEN 用户在项目文件管理界面点击"导入"按钮 THEN 系统 SHALL 支持批量上传 .txt 和 .md 文件（单文件最大1MB）
2. WHEN 文件上传完成 THEN 系统 SHALL 保存源文件并转换为 PDF/A 格式存储
3. WHEN 文件保存完成 THEN 系统 SHALL 异步执行文件内容向量化（每500 tokens分段，重叠50 tokens）并存储到 hnswsqlite
4. WHEN 文件向量化进行中 THEN 系统 SHALL 在文件列表显示"向量化进度/成功/失败"状态
5. WHEN 用户在项目聊天中发送消息且 RAG 开关开启 THEN 系统 SHALL 在项目向量库中检索相关内容作为上下文（默认开启，用户可在对话中灵活切换）
6. WHEN AI 回复包含文件引用 THEN 系统 SHALL 在回复下方显示前3-5条最相关引用标签（按得分排序，同文件多段引用可合并）
7. WHEN 用户点击引用标签 THEN 系统 SHALL 打开文件预览弹窗并高亮整个相关文本块
8. WHEN 用户编辑文件内容 THEN 系统 SHALL 删除旧向量→重新分段→批量 upsert 到向量库
9. WHEN 用户上传重复文件（相同MD5） THEN 系统 SHALL 跳过存储，仅追加索引引用
10. WHEN 用户删除文件 THEN 系统 SHALL 二次确认并删除源文件、PDF/A、向量和SQLite记录
11. WHEN PDF/A 转换失败 THEN 系统 SHALL 保留原文本文件并标红显示"转换失败"

### 需求 4：记忆与知识管理

**用户故事：** 作为用户，我希望能够为项目添加长期记忆和知识笔记，以便 AI 能够记住项目背景并帮我管理知识。

#### 验收标准

1. WHEN 用户进入项目记忆与知识界面 THEN 系统 SHALL 显示记忆列表和知识卡片网格
2. WHEN 用户添加新记忆 THEN 系统 SHALL 将其保存并在项目聊天时作为 system prompt 使用（每项目记忆≤10条）
3. WHEN 用户添加新知识 THEN 系统 SHALL 打开 Markdown 编辑器供用户编辑
4. WHEN 用户在聊天中选择文字 THEN 系统 SHALL 显示"存为知识"悬浮按钮，点击后弹框选择/新建知识卡片
5. WHEN 用户编辑记忆或知识 THEN 系统 SHALL 支持实时保存和删除操作

### 需求 5：全局搜索功能

**用户故事：** 作为用户，我希望能够快速搜索所有会话中的内容，以便快速找到历史对话信息。

#### 验收标准

1. WHEN 用户点击全局搜索图标或使用快捷键 ⌘/Ctrl+P THEN 系统 SHALL 弹出居中的搜索模态框
2. WHEN 用户输入搜索关键词并停止输入1秒 THEN 系统 SHALL 执行基于关键词的传统全文搜索（仅搜索会话文本内容）
3. WHEN 搜索完成 THEN 系统 SHALL 按会话更新时间倒序显示匹配结果
4. WHEN 显示搜索结果 THEN 系统 SHALL 高亮匹配关键词并显示上下文摘要
5. WHEN 搜索结果≥100条 THEN 系统 SHALL 采用虚拟列表+无限滚动，每次加载10条
6. WHEN 用户点击搜索结果 THEN 系统 SHALL 跳转到相应会话并定位到匹配内容

### 需求 6：会话管理功能

**用户故事：** 作为用户，我希望能够管理我的聊天会话，包括重命名、移动、删除等操作，以便更好地组织我的对话历史。

#### 验收标准

1. WHEN 用户悬浮在会话上 THEN 系统 SHALL 显示"更多"操作图标
2. WHEN 用户点击"更多"图标 THEN 系统 SHALL 显示操作菜单（重命名、移动、删除）
3. WHEN 用户选择移动会话到项目 THEN 系统 SHALL 保留历史记录但更新 RAG 上下文
4. WHEN 用户选择移出项目 THEN 系统 SHALL 将会话移到未归类并停用 RAG 功能
5. WHEN 用户重命名会话 THEN 系统 SHALL 更新会话标题并在边栏中反映

### 需求 7：设置与配置功能

**用户故事：** 作为用户，我希望能够配置 API 连接、调整应用外观和管理数据，以便个性化我的使用体验。

#### 验收标准

1. WHEN 用户进入设置界面 THEN 系统 SHALL 显示多标签页（API配置、数据管理、外观、关于）
2. WHEN 用户配置 Chat API 设置 THEN 系统 SHALL 提供测试连接功能并在失败时显示原始错误信息（如401 Unauthorized）
3. WHEN 用户配置 Embedding API 设置 THEN 系统 SHALL 提供测试连接功能并在失败时显示原始错误信息
4. WHEN 用户切换主题或修改 API 配置 THEN 系统 SHALL 将设置写入本地 SQLite 并在应用重启时保留
5. WHEN 用户切换主题 THEN 系统 SHALL 立即应用新主题到整个应用界面
6. WHEN 用户查看关于页面 THEN 系统 SHALL 显示应用版本、Logo 和相关链接

### 需求 8：用户界面与交互

**用户故事：** 作为用户，我希望应用界面直观易用，响应迅速，以便提高我的工作效率。

#### 验收标准

1. WHEN 应用启动 THEN 系统 SHALL 显示固定宽度260px的左侧边栏和自适应的右侧主界面
2. WHEN 用户在不同功能间切换 THEN 系统 SHALL 保持界面状态和用户输入
3. WHEN 系统执行后台任务（如向量化） THEN 系统 SHALL 显示适当的加载状态
4. WHEN 用户进行文件操作 THEN 系统 SHALL 提供实时反馈和进度指示
5. WHEN 应用支持浅色和深色主题 THEN 系统 SHALL 确保所有界面元素在两种主题下都清晰可见
6. WHEN 应用启动 THEN 系统 SHALL 支持国际化（i18n），提供中英文界面切换


### 需求 9：数据存储与管理

**用户故事：** 作为用户，我希望我的数据能够安全可靠地存储在本地，以便保护隐私并确保数据持久性。

#### 验收标准

1. WHEN 系统初始化 THEN 系统 SHALL 创建本地 SQLite 数据库（启用WAL模式）存储元数据并加全局写锁
2. WHEN 系统初始化 THEN 系统 SHALL 创建 hnswsqlite 向量数据库存储文件向量
3. WHEN 用户上传文件 THEN 系统 SHALL 生成 MD5 哈希并存储文件元数据
4. WHEN 系统存储会话数据 THEN 系统 SHALL 确保数据完整性和一致性
5. WHEN 用户查看数据管理设置 THEN 系统 SHALL 显示本地数据目录路径

### 需求 10：跨平台兼容性

**用户故事：** 作为用户，我希望应用能够在 macOS 和 Windows 系统上稳定运行，以便在不同设备上使用。

#### 验收标准

1. WHEN 应用在 macOS 上运行 THEN 系统 SHALL 遵循 macOS 界面设计规范
2. WHEN 应用在 Windows 上运行 THEN 系统 SHALL 遵循 Windows 界面设计规范
3. WHEN 应用处理文件路径 THEN 系统 SHALL 正确处理不同操作系统的路径格式
4. WHEN 应用访问系统资源 THEN 系统 SHALL 确保跨平台兼容性
5. WHEN 应用需要更新 THEN 系统 SHALL 预留远程更新功能接口（考虑使用 Electron-updater，定义更新源 URL 协议）
6. WHEN 开发和测试阶段 THEN 系统 SHALL 提供 mock 模式以支持前端独立开发和测试

### 需求 11：文档和帮助系统

**用户故事：** 作为用户，我希望能够获得完整的使用指导和技术支持，以便快速上手并解决使用中遇到的问题。

#### 验收标准

1. WHEN 用户首次使用应用 THEN 系统 SHALL 提供快速开始指南和功能介绍
2. WHEN 用户查看帮助文档 THEN 系统 SHALL 提供详细的功能说明和使用截图
3. WHEN 用户遇到错误 THEN 系统 SHALL 提供友好的错误提示和解决建议
4. WHEN 开发者查看技术文档 THEN 系统 SHALL 提供完整的 API 文档和架构说明
5. WHEN 用户需要故障排除 THEN 系统 SHALL 提供常见问题解答和错误代码对照表

### 需求 12：左侧边栏界面设计

**用户故事：** 作为用户，我希望左侧边栏能够清晰地组织和展示我的项目、聊天会话，并提供便捷的操作入口，以便高效管理我的工作内容。

#### 验收标准

1. WHEN 应用启动 THEN 系统 SHALL 在左侧边栏顶部固定显示 Knowlex Logo、"New Chat"按钮和全局搜索图标
2. WHEN 用户查看项目区域 THEN 系统 SHALL 显示"Projects"标题和右侧的"+"添加按钮
3. WHEN 用户悬浮在项目名称上 THEN 系统 SHALL 在右侧显示文件图标、书本图标和菜单选项图标
4. WHEN 用户点击项目的文件图标 THEN 系统 SHALL 在右侧主界面显示该项目的文件管理页面
5. WHEN 用户点击项目的书本图标 THEN 系统 SHALL 在右侧主界面显示该项目的记忆与知识管理页面
6. WHEN 用户点击项目的菜单选项图标 THEN 系统 SHALL 显示包含"重命名"和"删除"选项的菜单
7. WHEN 用户点击项目名称区域（非图标区域） THEN 系统 SHALL 在右侧主界面显示项目概览页面，包含新建聊天功能和文件管理、记忆与知识的入口
8. WHEN 用户点击项目的文件夹图标 THEN 系统 SHALL 展开/折叠显示该项目下的聊天会话列表
9. WHEN 用户悬浮在项目内聊天会话上 THEN 系统 SHALL 在时间戳位置显示菜单选项图标
10. WHEN 用户点击项目内聊天会话的菜单图标 THEN 系统 SHALL 显示"移动到"（展开其他项目名称）、"移出"（移动到未归类聊天区域）、"重命名"、"删除"选项
11. WHEN 用户查看项目内聊天会话 THEN 系统 SHALL 在右侧显示时间信息（刚刚、今天、昨天、X天前等）
12. WHEN 用户查看未归类聊天区域 THEN 系统 SHALL 显示"Chats"标题和所有未归类的聊天会话
13. WHEN 用户悬浮在未归类聊天会话上 THEN 系统 SHALL 在时间戳位置显示菜单选项图标
14. WHEN 用户点击未归类聊天会话的菜单图标 THEN 系统 SHALL 显示"移动到"（展开项目名称列表）、"重命名"、"删除"选项
15. WHEN 用户查看未归类聊天会话 THEN 系统 SHALL 在右侧显示时间信息（刚刚、今天、昨天、X天前等）
16. WHEN 未归类聊天会话数量较多 THEN 系统 SHALL 实现无限滚动，按最后修改时间倒序每次加载10个会话
17. WHEN 用户查看边栏底部 THEN 系统 SHALL 显示用户头像、用户名和右侧的设置图标
18. WHEN 用户点击设置图标 THEN 系统 SHALL 显示包含"配置"、"主题"、"语言"、"登出"选项的菜单
19. WHEN 用户选择主题选项 THEN 系统 SHALL 支持深色、浅色、系统主题的切换并立即生效
20. WHEN 用户选择语言选项 THEN 系统 SHALL 支持中英文切换并通过i18n立即生效
