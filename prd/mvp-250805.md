### 1. 产品概述

#### 1.1 愿景与服务对象

本产品是一款基于 Electron 构建的跨平台桌面应用，为**研究人员、开发者、技术写作者、分析师等专业用户**提供**一站式桌面智能助理**。

#### 1.2 核心能力

应用集成了对话式 AI、项目管理、文件处理和个性化知识记忆，旨在通过整合工作流程，解决以下关键痛点：

- **信息过载**：难以从大量资料中快速提炼要点。
- **上下文切换成本高**：工具分散导致专注力被打断。
- **知识沉淀困难**：灵感与资料分散，无法形成复用的个人知识库。
- **重复性上下文输入**：AI 交互中需多次提供同类背景信息。

#### 1.3 解决方案亮点

- **跨平台桌面应用（Electron + ReactUI）**
- **项目级 RAG（检索增强生成）**：自动把项目文件向量化并用于检索增强生成。
- **记忆系统**：项目长期记忆 + 个人全局记忆。
- **RAG 透明度**：AI 回复下方展示可点开的引用来源。
- **最小可行文件格式**：MVP 仅支持 `.txt` / `.md`，考虑后续支持 PDF 等文件。

---

### 2. 功能架构

#### 2.1 左侧边栏（导航区）

边栏固定宽度为 **260 px**，支持浅/深色主题切换。

- 产品 Logo：Knowlex

- **+ New Chat（新聊天）**
  - 始终置顶。点击即在右侧主界面创建一个新的空白会话。
  - 若当前窗口存在未发送或已超时的输入，再次点击则**清空输入并打开全新窗口**。
  - 只有**发送成功并收到回复**时才生成会话，初始标题为 **“Untitled Chat”**。待标题生成成功后替换。
- **Global Search（全局搜索）**
  - 放大镜图标。点击后弹出居中模态框，包含搜索输入框和关闭按钮。
  - 输入停止 **1 s** 或用户键入回车即触发全局全文搜索。
  - 输入框下方实时显示匹配结果，按会话更新时间倒序排列。
  - 每条结果显示：会话标题、包含关键词的上下文摘要（高亮显示匹配关键词）、所属项目名称。
  - 点击结果会在右侧跳转至相应会话并定位到匹配内容；左侧边栏高亮相应会话并滚动定位。
- **Projects（项目管理）**
  - 项目管理标题右侧显示 “+” 按钮，用于新建项目。
  - **新建项目弹窗**：要求输入项目名称（必填）和项目描述（选填）。**项目描述自动保存为该项目的一条记忆**。
  - 项目列表以折叠式展示：展开时显示项目下的会话。
  - **项目名称右侧图标**：文件管理（进入项目文件界面）、记忆与知识（进入记忆与知识界面）、更多选项（允许重命名或删除项目）。
  - **项目会话列表**：会话悬浮“更多”图标，支持：移到新项目、移出项目、重命名、删除。
- **Chats（未归类聊天会话）**
  - 列出所有未归入项目的会话，按最后更新时间倒序排列。
  - 悬浮“更多”图标，支持以下操作：归入项目、重命名会话、删除会话。
- **底部信息区**
  - 显示当前用户的头像和名称。
  - 设置图标：点击进入设置页面。

#### 2.2 右侧主界面（内容区）

右侧界面自适应宽度，根据用户在边栏的选择展示对应内容。

##### 2.2.1 新建与未归类聊天

- 初次进入或点击“New Chat”时，中心显示一个输入框，提示文本：

  > “你好，有什么可以帮你的吗？可以上传 TXT 或 MD 文件开始。”

- 支持上传 `.txt` 和 `.md` 文件：聊天发送时将文件内容连同问题一起作为上下文发送给 AI。

- 发送成功后自动生成**“Untitled Chat”**，并请求标题生成，成功后替换。

- 未归类聊天**不执行文件 RAG**，只将文件的文本内容作为上下文。

- 聊天界面右上角提供“归类”按钮，可将会话移动至指定项目。

##### 2.2.2 项目概览与聊天

- **点击项目名称**：左侧打开项目聊天列表，右侧加载项目概览页。
  - 居中聊天输入框（新会话自动归入此项目）。
  - 下方提供明显入口按钮：**项目文件**、**记忆与知识**。
- **点击项目下的会话**：右侧加载并显示完整历史记录。
- **RAG 流程**：发送新消息时，会话的 System Prompt 由项目记忆构成，检索上下文由项目的文件向量库提供。文件向量化是后台任务，向量化完成前，不允许用户提问。
- **会话移动和上下文管理**：
  - 从项目 X 移动到项目 Y：保留纯文本历史。当继续对话时，引用项目 Y 的记忆和向量库，同时忽略历史记录中与项目 X 文件相关的内容。
  - 移动到未归类：保留纯文本历史，但不执行任何 RAG，system prompt 使用全局默认，无项目级记忆。
- **RAG 透明度**：AI 回复下方展示**「引用 xxx 文件」**标签（1 个或多个）。点击标签后，打开**文件预览弹窗**，自动定位并高亮原文片段。

##### 2.2.3 项目内文件管理界面

- **入口**：项目列表中的文件管理图标，或项目项目概览页点击进入。
- 文件列表以卡片网格展示。每个文件卡片包含：
  - 首页文本的缩略图（对 `.txt` 和 `.md` 渲染首屏文本）。
  - 文件名称。
  - 创建时间。
- **上传流程**：右上角“导入”按钮，支持批量上传 `.txt` 和 `.md` 文件。
  - 上传后后台自动执行：保存源文件到应用数据目录 → 转为 PDF/A 副本并保存 → 生成 MD5 源文件和转换后文件的 + 写入 SQLite 元数据表
  - 同时异步执行：读取文件内容 → 向量化文本 + 写入向量库。
- **文件预览与编辑**：双击卡片进入**弹窗**（非分栏页面）。
  - 右侧：渲染 PDF/A 源文件，只读。
  - 左侧：Tab 切换：“内容”和“元数据”。
    - **内容 Tab**：可编辑用户查看的文本内容，保存后重新执行 embedding 并更新向量数据库条目，不影响 PDF/A 及源文件。
    - **元数据 Tab**：显示源文件和 PDF/A 文件的 MD5、创建时间、文件路径等，只读。

##### 2.2.4 项目记忆与知识界面

- **入口**：项目列表中的记忆与知识图标。
- **界面上下两部分**：
  - **记忆 (Memory)**：以列表形式呈现，每条占据一行，支持 CRUD（新增、编辑、删除）。新增时输入一句话或短句。系统在项目内任何聊天时使用项目记忆作为 system prompt。
  - **知识 (Knowledge)**：以卡片网格呈现，支持 CRUD。新增时打开模态框内的极简 Markdown 编辑器。知识内容不参与对话生成，仅供用户笔记管理。用户可以在项目聊天会话上下文中选择文字，右上角悬浮 icon 提示保存到知识。

##### 2.2.5 设置（Settings）界面

- 设置以多标签 (Tab) 显示。
- **API 配置 (API Configuration)**
  - **Chat API**：Base URL、API Key、Model Name。提供**测试连接**按钮。
  - **Embedding API**：Base URL、API Key、Model Name。提供**测试连接**按钮。
- **数据管理 (Data Management)**
  - 显示本地数据目录路径（**MVP 不支持修改**）。
  - MVP **不提供**备份与恢复功能。
- **外观 (Appearance)**
  - 主题切换：浅色模式 (Light)、深色模式 (Dark)、跟随系统 (System)。
- **关于 (About)**
  - 显示应用 Logo、当前版本号。
  - 提供可点击链接：官方网站、隐私政策、开源许可等信息。

---

### 3. 关键业务流程总结

#### 3.1 文件上传

- **支持格式**：`.txt`、`.md`。
- **上传位置**：项目聊天、项目文件管理。未归类聊天不支持上传。
- **自动流程**：上传文件 → 保存源文件到应用数据目录 → 转为 PDF/A 副本并保存 → 生成 MD5 源文件和转换后文件的 MD5 + 写入 SQLite 元数据表
- **自动流程（同时、异步）**：读取文本 → 向量化并存储（LanceDB）。
- **源文件**：保存源文件，并保存转换为 PDF/A 后的文件，对用户均只读（非文件系统只读）。
- **向量化内容**：用户可在文件预览中编辑，并重新生成向量。

#### 3.2 聊天与标题生成

- **消息类型**：支持文本消息和文件上传消息。
- **标题生成**：发送成功后立即创建 **“Untitled Chat”**，并发标题生成请求。根据对话内容生成一个不超过 10 个词的简洁标题，成功后替换。
- **会话移动**：会话可移动到项目或从项目移出。历史记录保留，但 `system prompt` 与检索库随位置变化。

#### 3.3 RAG（检索增强生成）

- **触发条件**：仅在项目内聊天时触发。
- **工作原理**：根据用户查询在项目的向量数据库中检索，并将相关片段作为上下文。同时，使用项目记忆作为 `system prompt`。
- **未归类聊天**：不执行 RAG 操作。

#### 3.4 记忆与知识

- **记忆**：与项目相关，为 `system prompt` 提供长期指导。
- **知识**：为独立笔记，不参与回复生成。

#### 3.5 全局搜索

- **交互方式**：模态框，支持关键词高亮、时间倒序、快速跳转。
- **触发时机**：在用户停止输入一秒后触发，以减轻系统负担。
