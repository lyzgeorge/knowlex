# Knowlex 产品需求文档 (PRD) v2.2

### 1. 产品概述

- **跨平台桌面应用**：基于 Electron + React + **Chakra UI** 构建，确保原生体验和设计一致性。
- **简化的技术栈**：使用 **libsql** (SQLite) 进行结构化数据和向量数据存储，简化部署和维护。
- 后台服务：使用 vercel 的 ai-sdk 来整合不同的服务商
- 需要用一个统一的 design token 来规范各组件的使用（品牌主色 \#2E7D32 ）
- 各功能模块和 UI 元素应尽量原子化，提供单一、可复用的功能

### 2. 功能架构

#### 2.1 左侧边栏（导航区）

固定宽度 **260px**，支持浅/深色主题。

- **产品 Logo**: Knowlex
- **+ New Chat (新聊天)**
  - 始终置顶。点击后，在右侧主界面创建一个新的、未归类的空白会话。
- **Global Search (全局搜索)**
  - 一个搜索输入框，用于全局搜索所有会话内容。
- **Chats (聊天列表)**
  - 存放所有未归入项目的会话，按更新时间倒序排列。
  - 条目显示聊天名称，右侧显示更新时间
  - **会话操作**：鼠标悬停到会话条目上，隐藏时间并在靠右的位置悬浮显示“...”菜单，支持“重命名”、“删除”。
  - 重命名会话将直接使用 iline editing
- **底部区域**
  - 用户头像与名称。
  - **设置 (Settings)** 图标：点击进入设置页面。

#### 2.2 右侧主界面（内容区）

##### 2.2.1 聊天界面（通用设计）

首页显示一个输入框，左侧有 + 按钮允许上传文件，右侧有 send 按钮发送。

当用户输入并发送后，页面渲染为聊天内容的页面，下方显示相同的输入框允许用户跟进提问。

如果用户有选择文件，则判断文件类型，如果是办公文件则使用 officeparser 处理并获取内容，如果是 pdf 文件则使用 pdf-parse 处理并获取内容，如果是图片显示缩略图，如果是纯文本文件直接获取文件内容。将文件名和文件内容作为上下文传入模型。

###### 2.2.1.1 消息结构与渲染

- **用户消息**：都由一个或多个内容部分组成，UI 需能按顺序正确渲染不同类型的内容：
  - **图片 (Image)**：渲染用户上传的图片预览，将图片按照 ai-sdk 中定义的方法传入。
  - **文件 (File)**：通过 officeparser 和 pdf-parse 支持文件上传时预处理，并将处理好的文本内容作为上下文传入模型。
  - **文本 (Text)**：支持完整 Markdown 渲染，包括代码块、列表、表格、引用等。代码块需提供语法高亮和一键复制功能。
- **AI 返回消息 - 流式响应 (Streaming)**：AI 的回复必须以流式（ai-sdk 中的 fullStream 函数）方式实时渲染，以提升用户体验
  - 根据是否收到 reasoning-start （或者是否包含 <think> </think> 标签）判断模型是否支持思考模式，如果支持，则以 streaming 的方式显示思考内容 box，并在收到 text-start 时收起思考内容的盒子
  - 允许用户在任何时候发送中断，及时停止 streaming 和后台数据接收，并将当前的数据（包含 reasoning 的部分）写入数据库


###### 2.2.1.2 核心交互功能

- **消息操作菜单**：鼠标悬浮在用户消息气泡上时，应显示一个操作菜单，提供以下功能：
  - **编辑并重试 (Edit & Retry)**：允许用户编辑自己的消息内容后，重新提交请求。AI 将基于修改后的内容生成新的回复，并替换掉原有的问答对。
    - 编辑和重试应当直接在用户消息气泡内完成
    - 编辑时允许用户添加或删除文件（如有）
  - **复制 (Copy)**：将该消息的 Markdown 原文内容复制到剪贴板。
  - **删除 (Delete)**：删除此条消息及其对应的问答（若为用户消息，则同时删除 AI 的回复）。

##### 2.2.2 标题生成

- **触发**: 任何会话（无论是否在项目中）的第一轮有效对话完成后触发。
- **流程**: 系统将用户的首次提问和 AI 的首次回答，通过 IPC 发送至主进程，由主进程调用 Chat Model，请求生成一个简洁的会话标题。
- **更新**: 生成成功后，通过 IPC 将新标题传回渲染进程，更新侧边栏中的临时标题（如“Untitled Chat”）。

##### 2.2.4 设置 (Settings) 界面

点击后在 app 上下左右居中处弹出窗口

- **API 配置 (API Configuration)**
  - **Chat Model**: Base URL, API Key, Model Name, `[Test Connection]` 按钮
- **数据管理 (Data Management)**
  - 显示本地数据存储路径（MVP 阶段不可修改）。
  - 提供备份导出和导入（覆盖）的功能
- **外观 (Appearance)**
  - 主题切换：浅色 (Light)、深色 (Dark)、跟随系统 (System)。
- **关于 (About)**
  - 应用 Logo、版本号等。
