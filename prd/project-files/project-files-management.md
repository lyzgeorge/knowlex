# 项目文件管理功能 PRD

## 功能概述

在 ProjectPage 的输入框下方新增项目文件管理功能，允许用户上传、管理项目资产文件，并通过AI异步生成智能标注（Smart Notes），提供文件内容的结构化管理和编辑能力。

## 核心价值

- **项目资产管理**: 将文件作为项目的持久化资产，与临时会话附件区别管理
- **智能标注**: AI异步提取文件结构、摘要、关键词等元信息
- **内容编辑**: 支持文件内容的markdown编辑和保存
- **异步处理**: 先保存文件元数据和内容，再异步生成智能标注，确保在模型不可用时仍能使用

## 用户故事

### 主要用户故事
- 作为用户，我想要上传文件到项目中，以便长期管理项目相关资料
- 作为用户，我想要查看文件的智能摘要和关键词，以便快速理解文件内容
- 作为用户，我想要编辑文件内容，以便完善或更新文档信息
- 作为用户，我想要重新生成文件的智能标注，以便获得更准确的分析结果

## UI布局设计

### 文件卡片弹窗设计
```
┌─ 文件详情弹窗 ────────────────────────────────────────┐
│  文件名: document.pdf                     [×关闭]     │
│  ┌─ 左侧面板 ─────────┐  ┌─ 右侧面板 ─────────────┐  │
│  │ [Metadata][SmartNote] │  │ 📝 内容编辑            │  │
│  │                     │  │                       │  │
│  │ === Metadata ===    │  │ ┌───────────────────┐ │  │
│  │ 文件名: document.pdf │  │ │                   │ │  │
│  │ 大小: 2.5MB         │  │ │   Markdown编辑器    │ │  │
│  │ 修改时间: 2024-01-15 │  │ │                   │ │  │
│  │ MD5: abc123...      │  │ │                   │ │  │
│  │                     │  │ │                   │ │  │
│  │ === Smart Notes === │  │ │                   │ │  │
│  │ 总结: [编辑框]       │  │ │                   │ │  │
│  │ 摘要: [多行编辑框]    │  │ └───────────────────┘ │  │
│  │ 关键词: [tag1][tag2] │  │ [保存] [重置]         │  │
│  │ 结构: [编辑框]       │  │                       │  │
│  │ [🔄 Regenerate]     │  │                       │  │
│  └─────────────────────┘  └─────────────────────────┘  │
│                                      [关闭] [保存]     │
└─────────────────────────────────────────────────────────┘
```

## 功能需求

### F1: 文件上传管理

#### F1.1 文件上传
- 支持多文件同时选择上传
- 支持的文件格式: 引用 `src/shared/constants/file.ts` 中的 `SUPPORTED_FILE_TYPES`
- 文件大小限制: 单文件≤50MB，项目总文件≤100个
- 上传后立即解析文件内容并存储元数据和原始文件，Smart Notes 异步生成

#### F1.2 文件列表展示
- 在ChatInputBox下方显示文件卡片网格
- 显示文件数量统计 (已上传/限制数量)
- 复用现有文件卡片组件：`src/renderer/components/ui/AttachmentCard.tsx`
- 支持文件删除操作

### F2: 智能文件分析

-#### F2.1 内容提取与表示（更新：不支持图片）
- 支持类型：PDF、Office 文档（docx/xlsx/pptx）、纯文本与代码文件（txt/md/csv/json/js/ts/tsx/py/java/c/cpp/cs 等）
- PDF：使用 pdfjs-dist 提取文本
- Office：使用 office-parser 提取文本
- 纯文本/代码：作为文本处理
- 统一性说明：仅对“文本型可解析”的文件生成 `content.txt`；图片及其他非文本型文件不支持上传（将被拒绝）
- **扩展性设计**: 为未来OCR、视频分析等功能预留架构空间
- **内存保护**: 设定文件解析内存阈值，超大文件采用流式/分块读取
- 提取并存储文件元数据(文件名、大小、修改时间、MD5等)

-#### F2.2 AI智能标注生成（异步流程，更新：以 chunks 表达结构，不再输出 structure）
- **异步执行**: 文件上传后先保存元数据和内容，Smart Notes 作为后台任务异步生成
- 使用指定的文件处理模型(支持独立配置或复用聊天模型)
- **输入预处理**：
  - 对原始内容逐行处理，并将每行封装为 `<行号>内容</行号>` 的格式（行号从 1 开始）。
  - 将用户内容中的 `<` 和 `>` 统一转义为 `&lt;` 与 `&gt;`，避免与分段标签冲突；不要修改其他字符或空白。
- **System Prompt**:
```
你是一个专业的文档分析助手。请分析提供的文档内容，提取关键信息并按照指定格式返回。

输入格式：每行内容已封装为 <行号>内容</行号> 的形式，例如 <1>第一行</1>。注意：内容中原始的 < 和 > 已被转义为 &lt; 和 &gt;，请不要反转义或修改内容。

分析要求：
1. 一句话总结：用一句话概括文档的核心内容或目的（保持既有产出要求）
2. 摘要描述：使用 5W1H 或 IRAC 原则提供完整段落描述（保持既有产出要求）
3. 关键词：提取类别、属性、标签、主题、核心概念（保持既有产出要求）
4. 语义分段（chunks）：仅基于行号，将相邻且语义连贯的行分为若干组；每组尽量保持在约 500 token。chunks 即表达文档的结构性信息，不再单独输出 structure。
   - 返回 JSON 数组：[{"id": number, "lines": number[]}]，其中 lines 为该组包含的行号。
   - 请不要改写或合并行内容，也不要推断未提供的行。

请严格按照 JSON schema 返回，仅输出一个 JSON 对象。
```
- **AI输出Schema（v1.1，仅业务字段；移除 structure）**:
```json
{
  "summary": "一句话总结文档核心内容",
  "abstract": "基于5W1H或IRAC原则的完整摘要描述段落",
  "keywords": ["关键词1", "关键词2", "关键词3"]
  "chunks": [
    { "id": 1, "lines": [1, 2, 3] },
    { "id": 2, "lines": [4, 5] }
  ]
}
```

**注意事项**:
- `chunks` 仅能引用输入中存在的行号，请勿修改内容本身
- 对用户输入中可能包含的 `<`、`>` 已在预处理阶段转义为 `&lt;`、`&gt;`，请勿反转义
- `status` 和 `generated_at` 等元数据由系统维护，不在 AI 输出中

#### F2.3 大文件处理策略
- 设定token限值(默认128K，用户可配置)
- 超限时使用迭代处理:
  - **第一轮处理**: 处理前30K token，使用标准System Prompt
  - **后续轮次处理**: 使用优化的迭代System Prompt：
```
你是一个专业的文档分析助手。你已经对文档的前半部分进行了初步分析。

现有的分析结果：
- 一句话总结：{previous_summary}
- 摘要描述：{previous_abstract}
- 关键词：{previous_keywords}
- 层级结构：{previous_structure}

现在请阅读以下新的内容块，基于已有分析结果，更新和完善你的分析：
1. 扩展或修正一句话总结（如果新内容改变了理解）
2. 补充摘要描述（保持连贯性，整合新信息）
3. 添加新发现的关键词，去重并保持相关性
4. 更新层级结构（如发现新的结构层次）

内容块：{new_content_chunk}

请返回更新后的完整分析结果，遵循相同的JSON schema。
```
  - 每次处理30K token（含2K overlap确保上下文连续性）
  - 递归直到处理完成

### F3: 文件详情管理

#### F3.1 双面板布局
- 左侧: Metadata + Smart Notes 标签页
- 右侧: Markdown内容编辑器(使用@uiw/react-md-editor)

#### F3.2 Metadata面板
- 只读显示文件基本信息
- 包含文件名、大小、修改时间、MD5等
- **[打开文件]** 按钮：调用系统默认程序打开原始文件

#### F3.3 Smart Notes面板（更新：移除层级结构字段）
- 一句话总结: 单行可编辑文本框
- 摘要描述: 多行可编辑文本框（显示完整段落文本）
- 关键词: 标签形式，支持增删改，**自动统一大小写和去重**
- 语义分段（chunks）: 只读或轻量编辑（可选后续版本）；用于表达文档的结构化区块与对应行号范围
- **状态显示增强**:
  - 显示生成状态（生成中/已完成/生成失败）
  - 显示上次生成时间
  - 生成中时禁用保存/再生成按钮
- **操作按钮**:
  - Regenerate按钮: 基于当前内容重新生成Smart Notes
  - 生成失败时提示用户点击 “Regenerate”按钮并显示错误详情

#### F3.4 内容编辑
- 右侧markdown编辑器显示和编辑文件内容（使用 `@uiw/react-md-editor`）
- **安全渲染**: 开启XSS防护和HTML白名单，防止注入攻击
- 支持保存修改到独立的content.txt文件
- **内容编辑策略**:
  - 用户编辑仅影响解析后的内容表示，**不会修改原始文件**
  - 编辑后，解析内容与原始文件**预期不一致**（这是正常行为）
  - 反向修改原始PDF/DOCX文件技术复杂，不在支持范围内
  - UI需要明确区分"自动解析内容"与"用户编辑内容"
- 支持重置到最初解析的内容（非原始文件重新解析）

### F4: 系统设置集成

#### F4.1 文件处理模型配置
- 在设置页面 - 模型设置新增"文件处理模型"选项
- 支持选择：使用默认聊天模型 或 指定独立模型
- 配置token处理限值(默认128K)

### F5: 原始文件访问

#### F5.1 文件存储和访问
- 上传时保存原始文件到本地存储目录
- 数据库记录原始文件路径 `file_path`
- 在文件详情弹窗的Metadata面板提供**[打开文件]**按钮
- **安全打开**:
  - 调用前检查文件路径存在且可读
  - 使用Electron的`shell.openPath(file_path)`安全打开
  - 防止路径穿越攻击

## 交互流程

### 文件上传流程
```
1. 点击[+上传] → 2. 文件选择器 → 3. 文件验证 → 4. 创建文件目录
                                                  ↓
5. 保存原始文件(original.<ext>) → 6. 解析内容 → 7. 保存解析内容(content.txt)
                                                  ↓
8. 存储元数据和路径到数据库 → 9. 显示文件卡片 → 10. 异步生成Smart Notes
```

### 文件查看编辑流程
```
1. 点击文件卡片 → 2. 弹出详情窗口 → 3. 选择Metadata/SmartNote标签
                                ↓
                         4. 查看/编辑内容 → 5. 点击保存 → 6. 更新数据库
```

### Smart Notes重新生成流程
```
1. 详情窗口 → 2. 点击Regenerate → 3. 基于当前content重新AI分析
                                ↓
                         4. 更新Smart Notes显示
```

## 数据模型

### 项目文件表 (project_files)
- id: 主键
- project_id: 项目ID(外键)
- filename: 文件名
- file_size: 文件大小
- mime_type: 文件 MIME 类型（标准化命名，取代原 `file_type`）
- file_hash: 文件MD5
- file_path: 原始文件存储路径
- content_path: 解析后文件内容的存储路径
- upload_time: 上传时间
- created_at / updated_at: 时间戳
- smart_notes: AI生成的结构化标注(JSON)
- smart_notes_status: "pending|processing|completed|failed"
- smart_notes_generated_at: "2024-01-15T10:00:00Z"
- **smart_notes_schema_version: "1.1"** (Schema版本号，支持未来兼容性)

### Smart Notes JSON结构 (Schema v1.1，更新：移除 structure，信息由 chunks 表达)
```json
{
  "summary": "一句话总结文档核心内容",
  "abstract": "基于5W1H或IRAC原则的完整摘要描述段落",
  "keywords": ["关键词1", "关键词2", "关键词3"],
  "chunks": [
    { "id": 1, "lines": [1, 2, 3] },
    { "id": 2, "lines": [4, 5] }
  ]
}
```

**Schema版本管理**:
- 当前版本: v1.1
- 未来扩展示例: 可能增加`sentiment`(情感分析)、`topics`(主题分类)等字段
- 兼容性策略: 系统可根据`smart_notes_schema_version`字段识别数据版本，为未来的功能扩展和格式升级提供支持。

## 约束条件与安全要求

### 业务约束
- 每个项目最多100个文件
- 单文件大小限制50MB
- **边界说明**: 项目文件与会话附件完全独立，不支持相互转换迁移
- 文件删除不可恢复
- **内容编辑限制**: 用户编辑仅影响解析内容，不会反向修改原始文件，这是预期的设计行为

### 安全与输入校验
- **文件名安全**: 统一sanitize上传文件名，限制路径分隔符和软链接
- **路径安全**: 防止路径穿越，使用白名单验证存储路径
- **内容安全**: Markdown渲染开启XSS防护和HTML标签白名单
- **系统调用安全**: 打开文件前验证路径存在和权限

### 技术约束
- 大文件AI处理采用分块策略，避免超出模型上下文限制
- **内存保护**: 设定解析内存阈值，防止极端文件导致内存溢出
- **Schema兼容性**: 通过`smart_notes_schema_version`字段支持未来Schema升级和数据迁移
- **外部内容存储**: 解析后的文件内容存储为独立文件，数据库仅保存路径，避免数据库膨胀
- **解耦存储结构**: 使用`<projectId>/<fileId>/`目录结构，完全解耦用户文件名，提升系统健壮性
- 原始文件和解析内容均保存在本地存储目录，确保离线访问
- Smart Notes生成失败时，保留原始文件和解析内容

### 性能约束与用户体验（更新）
- **上传体验**: 文件上传支持进度显示和细化状态提示
- **生成队列体验**:
  - 实时更新文件处理状态（如：pending、processing、completed、failed），展示最近一次状态时间戳。
  - 首版移除精确的队列位置与等待时间预估，避免实现复杂度；后续版本可在不影响幂等性的前提下择机引入。
- **列表性能**: 文件列表支持分页(超过20个文件时)，筛选和排序

## 实现要点

### 代码复用
- 文件格式支持: 复用 `src/shared/constants/file.ts` 中的 `SUPPORTED_FILE_TYPES`
- 文件卡片UI: 复用 `src/renderer/components/ui/AttachmentCard.tsx`
- 文件解析逻辑: 复用现有的 file-parser 相关服务
- Markdown编辑器: 使用 `@uiw/react-md-editor` 包
- **错误处理**: 复用 `@main/utils/error.ts` 中的统一错误处理模式

### 存储架构要点
- **外部内容存储**: 解析内容存储为独立文件，提升性能和可扩展性
- **解耦目录结构**: `<projectId>/<fileId>/original.<ext>` 和 `<projectId>/<fileId>/content.txt`
- **扩展名保留**: 原始文件保留扩展名，确保系统程序能正确识别和打开
- **路径管理**: 数据库存储文件路径，支持内容版本控制和差异比对
- **存储隔离**: 每个文件独立目录，便于管理和扩展（如缩略图、版本等）

### 异步处理要点（更新）
- 上传时先保存文件元数据和解析内容到文件系统
- Smart Notes 生成作为后台异步任务
- 支持在模型不可用时仍能正常上传和管理文件
- 提供Smart Notes生成状态的实时反馈
 - 首版采用单并发 FIFO 队列；不提供精确队列位次与等待时间预估

### 队列幂等与恢复（新增）
- durable 状态：以 `smart_notes_status` 为任务来源，应用启动时扫描 `pending` 与 `processing` 状态进行恢复。
- 过期处理：启动时对“处于 `processing` 超过阈值（例如 30 分钟）”的任务标记为 `pending` 重新入队（crash 恢复）。
- 去重策略：同一 `fileId` 任务仅保留一份，避免重复入队。
- 取消/重试：引入最大重试次数与退避策略（例如最多 3 次，指数退避）；用户手动 Regenerate 将重置 `error` 与 `status`，新任务替换旧任务。

### 性能与队列管理
- 大文件采用分块策略避免超出模型上下文限制
- 文件列表支持分页显示(超过20个文件时)
- **Smart Notes队列管理**:
  - 采用FIFO队列，一次只处理一个文件
  - 维护全局队列状态，实时更新队列位置
  - 支持队列位置查询和预估等待时间计算
- 异步生成过程不阻塞用户其他操作�用户其他操作
不阻塞用户其他操作�用户其他操作
